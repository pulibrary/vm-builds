---
# Linux distribution specific tasks.

# Tasks for creating the local group for Ansible.
- name: Creating the local group for Ansible.
  ansible.builtin.group:
    name: "{{ ansible_username }}"

# Tasks for creating the sudo group.
- name: Creating the sudo group.
  ansible.builtin.group:
    name: sudo

# Tasks for creating the local user for Ansible.
- name: Creating the local user for Ansible.
  ansible.builtin.user:
    name: "{{ ansible_username }}"
    group: "{{ ansible_username }}"
    groups: sudo
    password: "!"
    shell: /bin/bash

# Tasks for managing the authorized keys for the local users.
- name: Managing the authorized keys for the local users.
  ansible.posix.authorized_key:
    user: "{{ item.user }}"
    key: "{{ item.key }}"
  loop:
    - user: "{{ ansible_username }}"
      key: "{{ ansible_key }}"
    - user: "{{ build_username }}"
      key: "{{ build_key }}"
  no_log: true

# Tasks for managing sudoers.d for the local users.
- name: Managing sudoers.d for the local users.
  community.general.sudoers:
    name: "{{ item }}"
    user: "{{ item }}"
    runas: ALL
    group: ALL
    commands: ALL
    nopassword: true
  loop:
    - "{{ build_username }}"
    - "{{ ansible_username }}"

- name: Ensure sudo group exists
  ansible.builtin.group:
    name: sudo
  tags: ['pulsys']

- name: Create group for pulsys
  ansible.builtin.group:
    name: pulsys
    gid: 1050
  when: pulsys_enabled
  tags: ['pulsys']

- name: Create pulsys user
  ansible.builtin.user:
    name: pulsys
    uid: 1050
    group: pulsys
    groups: sudo
    shell: /bin/bash
    password: "!"
    create_home: true
  when: pulsys_enabled
  tags: ['pulsys']

- name: Ensure ~pulsys/.ssh exists
  ansible.builtin.file:
    path: /home/pulsys/.ssh
    state: directory
    owner: pulsys
    group: pulsys
    mode: '0700'
  when: pulsys_enabled
  tags: ['pulsys']

- name: Install pulsys authorized_keys from dynamic GitHub lists
  ansible.builtin.template:
    src: pulsys_authorized_keys.j2
    dest: /home/pulsys/.ssh/authorized_keys
    owner: pulsys
    group: pulsys
    mode: '0600'
  when: pulsys_enabled
  tags: ['pulsys']

- name: Add pulsys to sudoers.d
  community.general.sudoers:
    name: pulsys
    user: pulsys
    runas: ALL
    group: ALL
    commands: ALL
    nopassword: true
  when: pulsys_enabled
  tags: ['pulsys']

# Allow SSH for pulsys + the current ansible user during provisioning
- name: Determine SSH service name
  ansible.builtin.set_fact:
    ssh_service_name: "{{ 'ssh' if ansible_os_family == 'Debian' else 'sshd' }}"

- name: Remove any existing AllowUsers lines (provisioning phase)
  ansible.builtin.replace:
    path: /etc/ssh/sshd_config
    regexp: '^\s*AllowUsers\b.*$'
    replace: ''
    backup: yes
  when: not (cleanup_final_image | bool)
  notify: Restart SSH

- name: Ensure global AllowUsers permits pulsys and {{ ansible_user }} (provisioning phase)
  ansible.builtin.blockinfile:
    path: /etc/ssh/sshd_config
    insertbefore: '^Match\b'
    marker: '# {mark} managed by Ansible (provisioning AllowUsers)'
    block: |
      AllowUsers pulsys {{ ansible_user }}
  when: not (cleanup_final_image | bool)
  notify: Restart SSH

- name: Validate sshd configuration (provisioning phase)
  ansible.builtin.command: /usr/sbin/sshd -t -f /etc/ssh/sshd_config
  register: sshd_check_build
  changed_when: false
  failed_when: sshd_check_build.rc != 0
  when: not (cleanup_final_image | bool)
