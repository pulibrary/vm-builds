#!/usr/bin/env bash
# {{ ansible_managed | comment }}
set -euo pipefail

STATE_DIR="/var/lib/security-firstboot"
MARKER="${STATE_DIR}/bigfix.done"

# choose OS family
OS_FAMILY="$(. /etc/os-release; echo "${ID_LIKE:-$ID}")"

# Required: masthead URL must be provided at boot via {{ security_env_file }}
: "${BIGFIX_MASTHEAD_URL:=}"

if [[ -f "$MARKER" ]]; then
  exit 0
fi

if [[ -z "${BIGFIX_MASTHEAD_URL}" ]]; then
  echo "BigFix: no BIGFIX_MASTHEAD_URL provided; skipping install."
  exit 0
fi

mkdir -p /opt/BESClient

# Prefer embedded masthead if provided
if [[ -n "${BIGFIX_MASTHEAD_B64:-}" ]]; then
  echo "$BIGFIX_MASTHEAD_B64" | base64 -d > /opt/BESClient/actionsite.afxm || {
    echo "BigFix: failed to decode BIGFIX_MASTHEAD_B64; skipping."
    exit 0
  }
  chmod 0600 /opt/BESClient/actionsite.afxm
elif [[ -n "${BIGFIX_MASTHEAD_URL:-}" ]]; then
  if ! curl -fsSL --max-time 75 "$BIGFIX_MASTHEAD_URL" -o /opt/BESClient/actionsite.afxm; then
    echo "BigFix: cannot fetch masthead from $BIGFIX_MASTHEAD_URL; skipping."
    exit 0
  fi
  chmod 0600 /opt/BESClient/actionsite.afxm
else
  echo "BigFix: no masthead provided; skipping."
  exit 0
fi

# service name varies; try both
systemctl enable besclient.service 2>/dev/null || true
systemctl enable besclient 2>/dev/null || true
systemctl restart besclient.service 2>/dev/null || systemctl restart besclient || true

touch "$MARKER"
exit 0
