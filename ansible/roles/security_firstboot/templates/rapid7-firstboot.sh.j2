#!/usr/bin/env bash
# {{ ansible_managed | comment }}
#
set -euo pipefail

STATE_DIR="/var/lib/security-firstboot"
MARKER="${STATE_DIR}/rapid7.done"
OS_FAMILY="$(. /etc/os-release; echo "${ID_LIKE:-$ID}")"

: "${RAPID7_TOKEN:=}"

if [[ -f "$MARKER" ]]; then exit 0; fi

if command -v dpkg >/dev/null 2>&1; then
  if [[ -n "${RAPID7_DEB_URL:-}" ]]; then
    if ! curl -fsSL --retry 3 --retry-delay 2 "$RAPID7_DEB_URL" -o /tmp/rapid7.deb; then
      echo "Rapid7: cannot fetch DEB ($RAPID7_DEB_URL); skipping."
      exit 0
    fi
    apt-get update -y || true
    apt-get -y install /tmp/rapid7.deb || { echo "Rapid7: install failed; skipping."; exit 0; }
  else
    echo "Rapid7: no RAPID7_DEB_URL provided; skipping."
    exit 0
  fi
else
  # RHEL-like
  if [[ -n "${RAPID7_RPM_URL:-}" ]]; then
    if ! curl -fsSL --retry 3 --retry-delay 2 "$RAPID7_RPM_URL" -o /tmp/rapid7.rpm; then
      echo "Rapid7: cannot fetch RPM ($RAPID7_RPM_URL); skipping."
      exit 0
    fi
    dnf -y install /tmp/rapid7.rpm || yum -y install /tmp/rapid7.rpm || { echo "Rapid7: install failed; skipping."; exit 0; }
  else
    echo "Rapid7: no RAPID7_RPM_URL provided; skipping."
    exit 0
  fi
fi

systemctl enable --now ir_agent.service 2>/dev/null || true
touch "$MARKER"
exit 0
