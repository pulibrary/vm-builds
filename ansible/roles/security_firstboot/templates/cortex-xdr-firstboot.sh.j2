#!/usr/bin/env bash
# {{ ansible_managed | comment }}
set -euo pipefail

STATE_DIR="/var/lib/security-firstboot"
MARKER="${STATE_DIR}/cortex-xdr.done"
WORK_DIR="/tmp/cortex-xdr-install"

mkdir -p "$STATE_DIR"

# Env provided by systemd EnvironmentFile (/etc/pul/security-tools.env)
# Determine which tarball URL to use based on OS family
if command -v dpkg >/dev/null 2>&1; then
  # Debian/Ubuntu - use DEB tarball
  CORTEX_TARBALL_URL="${CORTEX_XDR_DEB_TARBALL_URL:-{{ cortex_xdr_deb_tarball_url }}}"
else
  # RHEL/Rocky - use RPM tarball
  CORTEX_TARBALL_URL="${CORTEX_XDR_RPM_TARBALL_URL:-{{ cortex_xdr_rpm_tarball_url }}}"
fi

[[ -f "$MARKER" ]] && exit 0

if [[ -z "$CORTEX_TARBALL_URL" ]]; then
  echo "Cortex XDR: no tarball URL configured for this OS; skipping."
  exit 0
fi

# Create working directory
mkdir -p "$WORK_DIR"
cd "$WORK_DIR"

echo "Cortex XDR: downloading tarball from $CORTEX_TARBALL_URL..."
curl -fsSL --max-time 120 "$CORTEX_TARBALL_URL" -o cortex-xdr.tar.gz || {
  echo "Cortex XDR: cannot fetch tarball; skipping."
  rm -rf "$WORK_DIR"
  exit 0
}

echo "Cortex XDR: extracting tarball..."
tar xzf cortex-xdr.tar.gz

# The tarball should contain cortex.conf and DEB or RPM packages
# Following the manual installation steps from README

# Step 1: Copy cortex.conf to /etc/panw/
if [[ -f cortex.conf ]]; then
  echo "Cortex XDR: installing configuration..."
  mkdir -p /etc/panw
  cp cortex.conf /etc/panw/
  chmod 0600 /etc/panw/cortex.conf
else
  echo "Cortex XDR: WARNING - cortex.conf not found in tarball"
fi

# Step 2: Import GPG key if available
{% if cortex_xdr_gpg_key_url %}
echo "Cortex XDR: importing GPG key..."
curl -fsSL "{{ cortex_xdr_gpg_key_url }}" | rpm --import - || true
{% endif %}

# Step 3: Install package (DEB or RPM based on OS)
installed=false
if command -v dpkg >/dev/null 2>&1; then
  # Debian/Ubuntu - install DEB
  CORTEX_DEB=$(find . -name "*.deb" -type f | head -n1)
  if [[ -n "$CORTEX_DEB" && -f "$CORTEX_DEB" ]]; then
    echo "Cortex XDR: installing DEB package $CORTEX_DEB..."
    apt-get update -y || true
    if apt-get -y install "$CORTEX_DEB"; then
      installed=true
    fi
  else
    echo "Cortex XDR: no DEB package found in tarball"
  fi
else
  # RHEL/Rocky - install RPM
  CORTEX_RPM=$(find . -name "*.rpm" -type f | head -n1)
  if [[ -n "$CORTEX_RPM" && -f "$CORTEX_RPM" ]]; then
    echo "Cortex XDR: installing RPM package $CORTEX_RPM..."
    if dnf -y install "$CORTEX_RPM" 2>/dev/null || yum -y install "$CORTEX_RPM"; then
      installed=true
    fi
  else
    echo "Cortex XDR: no RPM package found in tarball"
  fi
fi

# Cleanup
cd /
rm -rf "$WORK_DIR"

if [[ "$installed" == true ]]; then
  # Enable and start the service (adjust service name as needed)
  # The actual service name may vary - common names include:
  # - cytool (Cortex XDR agent service)
  # - traps_pmd (older versions)
  systemctl enable --now cytool.service 2>/dev/null || true
  systemctl enable --now traps_pmd.service 2>/dev/null || true
  
  touch "$MARKER"
  echo "Cortex XDR: installed successfully."
else
  echo "Cortex XDR: installation failed."
fi

exit 0
